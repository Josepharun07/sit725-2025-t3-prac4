<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SIT 725 Prac 3 - Movie Database</title>
    <meta name="description" content="SIT725 week 4: Movie Database Application">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <nav class="cyan">
        <div class="nav-wrapper navbar-size">
            <a href="#" class="brand-logo">
                <img class="user-image-size" src="images/user_icon1.png" alt="User Icon"/>
            </a>
            <ul id="nav-mobile" class="right hide-on-med-and-down">
                <li><a target="_blank" href="https://www.linkedin.com/in/arun-joseph-780550204/">LinkedIn</a></li>
            </ul>
        </div>
    </nav>
    
    <main class="main-body">
        <div class="container">
            <div class="row">
                <div class="col s12 center-align">
                    <h1 id="heading">Movie Database</h1>
                    <p class="flow-text">Browse our collection of movies or add your own!</p>
                </div>

                <div class="col s12 center-align" style="margin-bottom: 30px;">
                    <a class="waves-effect waves-light btn-large green modal-trigger" href="#modal1">
                        <i class="material-icons left">add</i>Add New Movie
                    </a>
                </div>

                <div id="movie-container" class="row">
                    <div class="col s12 center-align">
                        <div class="preloader-wrapper big active">
                            <div class="spinner-layer spinner-green-only">
                                <div class="circle-clipper left">
                                    <div class="circle"></div>
                                </div>
                                <div class="gap-patch">
                                    <div class="circle"></div>
                                </div>
                                <div class="circle-clipper right">
                                    <div class="circle"></div>
                                </div>
                            </div>
                        </div>
                        <p>Loading movies...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>


    <div id="modal1" class="modal modal-fixed-footer">
        <div class="modal-content">
            <h4>Add New Movie</h4>
            <form id="movieForm">
                <div class="row">
                    <div class="input-field col s12">
                        <input id="movie_title" type="text" class="validate" required>
                        <label for="movie_title">Movie Title *</label>
                    </div>
                </div>
                <div class="row">
                    <div class="input-field col s12">
                        <input id="movie_director" type="text" class="validate" required>
                        <label for="movie_director">Director *</label>
                    </div>
                </div>
                <div class="row">
                    <div class="input-field col s12">
                        <input id="release_year" type="number" class="validate" min="1800" max="2025" required>
                        <label for="release_year">Release Year *</label>
                    </div>
                </div>
                <div class="row">
                    <div class="input-field col s12">
                        <input id="movie_image" type="text" class="validate" placeholder="images/movie.jpg">
                        <label for="movie_image">Image Path (optional)</label>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close waves-effect waves-red btn-flat">Cancel</a>
            <a href="#!" class="waves-effect waves-green btn green" id="formSubmit">
                <i class="material-icons left">send</i>Submit
            </a>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    
    <script>

        async function fetchMovies() {
            try {
                const response = await fetch('/getMovies');
                const data = await response.json();

                const movieContainer = document.getElementById('movie-container');
                
                if (data.statusCode === 200 && data.data.length > 0) {
                    movieContainer.innerHTML = '';
                    
                    data.data.forEach(movie => {
                        const movieCard = `
                            <div class="col s12 m6">
                                <div class="card">
                                    <div class="card-image">
                                        <img src="${movie.image}" alt="${movie.title}" onerror="this.src='images/default.jpg'">
                                        <span class="card-title">${movie.title}</span>
                                    </div>
                                    <div class="card-content">
                                        <p><strong>Director:</strong> ${movie.director}</p>
                                        <p><strong>Year:</strong> ${movie.year}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                        movieContainer.innerHTML += movieCard;
                    });
                } else {
                    movieContainer.innerHTML = '<div class="col s12 center-align"><h5>No movies found. Add some movies to get started!</h5></div>';
                }
            } catch (error) {
                console.error('Error fetching movies:', error);
                M.toast({ html: 'Error loading movies. Make sure the server is running!', classes: 'red' });
                document.getElementById('movie-container').innerHTML = 
                    '<div class="col s12 center-align"><h5 class="red-text">Error loading movies. Please check console.</h5></div>';
            }
        }


        async function addMovie() {
            const movieTitle = document.getElementById('movie_title').value.trim();
            const movieDirector = document.getElementById('movie_director').value.trim();
            const releaseYear = document.getElementById('release_year').value;
            const movieImage = document.getElementById('movie_image').value.trim() || 'images/default.jpg';

            if (!movieTitle || !movieDirector || !releaseYear) {
                M.toast({ html: 'Please fill in all required fields!', classes: 'orange' });
                return;
            }

            try {
                const response = await fetch('/addMovie', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        title: movieTitle, 
                        director: movieDirector, 
                        year: releaseYear,
                        image: movieImage
                    }),
                });

                const data = await response.json();
                
                if (data.statusCode === 200) {
                    M.toast({ html: 'Movie added successfully!', classes: 'green' });
                    fetchMovies();
                    

                    document.getElementById('movieForm').reset();
                    const modal = M.Modal.getInstance(document.getElementById('modal1'));
                    modal.close();
                } else {
                    M.toast({ html: 'Failed to add movie!', classes: 'red' });
                }
            } catch (error) {
                console.error('Error adding movie:', error);
                M.toast({ html: 'Error adding movie. Check console for details.', classes: 'red' });
            }
        }


        document.addEventListener('DOMContentLoaded', function() {

            M.AutoInit();
            

            fetchMovies();


            document.getElementById('formSubmit').addEventListener('click', function(event) {
                event.preventDefault();
                addMovie();
            });
        });
    </script>
</body>
</html>